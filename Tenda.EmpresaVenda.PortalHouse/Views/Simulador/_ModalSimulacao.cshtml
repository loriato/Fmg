@using Europa.Resources
@using Tenda.Domain.EmpresaVenda.Enums
@using Tenda.EmpresaVenda.PortalHouse.Models.Application
@using Europa.Extensions
@using Tenda.EmpresaVenda.ApiService.Models.Util

@model Tenda.EmpresaVenda.ApiService.Models.PreProposta.PrePropostaCreateDto

@*<script type="text/javascript" src="~/Static/projeto/simulador/simulador.js"></script>*@
<script type="text/javascript" src="~/Static/projeto/simulador/modal-simulador.js"></script> 

@{
    Model.PodeManterAssociacoes = Model.PreProposta != null &&
                                  Model.PreProposta.Id > 0 &&
                                  (SituacaoProposta.EmElaboracao == Model.PreProposta.SituacaoProposta ||
                                   SituacaoProposta.DocsInsuficientesSimplificado == Model.PreProposta.SituacaoProposta ||
                                   SituacaoProposta.Condicionada == Model.PreProposta.SituacaoProposta ||
                                    SituacaoProposta.DocsInsuficientesCompleta == Model.PreProposta.SituacaoProposta ||
                                   SituacaoProposta.AguardandoFluxo == Model.PreProposta.SituacaoProposta);
}

@{
    var listaTipoParcelasItbi = TipoParcelaWrapper.TipoParcelaItbiEmolumento().Select(x => new SelectListItem
    {
        Text = x.AsString(),
        Value = "" + (int)x
    });

    var listaTipoParcelasDetalhamentoFinanceiro = TipoParcelaWrapper.TipoParcelaDetalhamentoFinanceiro().Select(x => new SelectListItem
    {
        Text = x.AsString(),
        Value = "" + (int)x
    });
}

<script>

    //SIMULADOR
    Europa.Controllers.Simulador.UrlDetalhamentoFinanceiroBySimulador = '@Url.Action("DetalhamentoFinanceiroBySimulador", "Simulador")';
    Europa.Controllers.Simulador.UrlAtualizarResultadosSimulacao='@Url.Action("AtualizarResultadosSimulacao", "Simulador")';
    Europa.Controllers.Simulador.UrlMontarUrlSimulador= '@Url.Action("MontarUrlSimulador","Simulador")';
    Europa.Controllers.Simulador.UrlAplicarDetalhamentoFinanceiro = '@Url.Action("AplicarDetalhamentoFinanceiro", "Simulador")';

    Europa.Controllers.Simulador.Permissoes = {
        DetalhamentoFinanceiroManual:'@SessionAttributes.Current().HasPermission(ViewBag.Codigo, "DetalhamentoFinanceiroManual").ToString().ToLower()'=='true'
    }

    //DETALAHMENTO FINANCEIRO
    Europa.Controllers.Simulador.UrlListarDetalhamentoFinanceiro = '@Url.Action("DetalhamentoFinanceiro", "Simulador")';
    Europa.Controllers.Simulador.UrlIncluirDetalhamentoFinanceiro = '@Url.Action("IncluirDetalhamentoFinanceiro", "PreProposta")';
    Europa.Controllers.Simulador.UrlAlterarDetalhamentoFinanceiro = '@Url.Action("AlterarDetalhamentoFinanceiro", "PreProposta")';
    Europa.Controllers.Simulador.UrlExcluirDetalhamentoFinanceiro = '@Url.Action("ExcluirDetalhamentoFinanceiro", "PreProposta")';
    Europa.Controllers.Simulador.UrlAtualizarTotalFinanceiro = '@Url.Action("DetalhamentoFinanceiro", "Simulador")';
    Europa.Controllers.Simulador.PermissoesDetalhamentoFinanceiro = {
        Visualizar: '@SessionAttributes.Current().HasPermission(ViewBag.Codigo, "VisualizarDetalhamentoFinanceiro").ToString().ToLower()',
        Incluir: '@SessionAttributes.Current().HasPermission(ViewBag.Codigo, "IncluirDetalhamentoFinanceiro").ToString().ToLower()',
        Excluir: '@SessionAttributes.Current().HasPermission(ViewBag.Codigo, "ExcluirDetalhamentoFinanceiro").ToString().ToLower()',
        Atualizar: '@SessionAttributes.Current().HasPermission(ViewBag.Codigo, "AlterarDetalhamentoFinanceiro").ToString().ToLower()'
    };
    Europa.Controllers.Simulador.DropDownTipoParcelaDetalhamentoFinanceiro =
        '@Html.Raw(Ajax.JavaScriptStringEncode(Html.DropDownList("TipoParcela", listaTipoParcelasDetalhamentoFinanceiro,
        new { @class = "form-control" }).ToHtmlString()))';

    //ITBI
    Europa.Controllers.Simulador.UrlListarItbiEmolumento = '@Url.Action("ItbiEmolumentoBySimulador", "Simulador")';
    Europa.Controllers.Simulador.UrlIncluirItbiEmolumento = '@Url.Action("IncluirDetalhamentoFinanceiro", "PreProposta")';
    Europa.Controllers.Simulador.UrlAlterarItbiEmolumento = '@Url.Action("AlterarDetalhamentoFinanceiro", "PreProposta")';
    Europa.Controllers.Simulador.UrlExcluirItbiEmolumento = '@Url.Action("ExcluirDetalhamentoFinanceiro", "PreProposta")';

    Europa.Controllers.Simulador.DropDownTipoParcelaItbiEmolumento =
        '@Html.Raw(Ajax.JavaScriptStringEncode(Html.DropDownList("TipoParcela", listaTipoParcelasItbi,
        new { @class = "form-control" }).ToHtmlString()))';

    Europa.Controllers.Simulador.PermissoesItbiEmolumento = {
        Visualizar: '@SessionAttributes.Current().HasPermission(ViewBag.Codigo, "VisualizarItbiEmolumento").ToString().ToLower()',
        Incluir: '@SessionAttributes.Current().HasPermission(ViewBag.Codigo, "IncluirDetalhamentoFinanceiro").ToString().ToLower()',
        Excluir: '@SessionAttributes.Current().HasPermission(ViewBag.Codigo, "ExcluirDetalhamentoFinanceiro").ToString().ToLower()',
        Atualizar: '@SessionAttributes.Current().HasPermission(ViewBag.Codigo, "AlterarDetalhamentoFinanceiro").ToString().ToLower()'
    };

</script>

<div id="modal-simulacao" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header flex-row justify-content-between">
                <div class="p-2">
                    <h4 class="modal-title">@GlobalMessages.Resultado</h4>
                </div>
                <div class="p-2">
                    <button type="button" class="close" onclick="Europa.Controllers.Simulador.FecharModalSimulador()" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>

            </div>
            <div class="modal-body">
                <div class="d-flex">
                    <div class="p-2 flex-grow-1">
                        @GlobalMessages.Simulacoes
                        @Html.DropDownList("simulacoes", new List<SelectListItem>(), GlobalMessages.Selecione, new { @class = "form-control", onChange = "Europa.Controllers.Simulador.OnChangeSimulacao()" })
                    </div>
                    <div class="p-2 flex-grow-2" style="padding-left: 10px;">
                        @if (Model.PodeManterAssociacoes)
                        {
                            <button id="btn_simulador" class="btn button__red__outline" type="button"
                                    style="margin-top:16px"
                                    onclick="Europa.Controllers.Simulador.AtualizarSimulacoes()">
                                <i class="fas fa-sync"></i>
                            </button>
                        }
                    </div>
                    <div class="p-2 flex-grow-2">
                        @if (Model.PodeManterAssociacoes)
                        {
                            <button id="btn_simulador" class="btn button__red__outline" type="button"
                                    style="margin-top:16px"
                                    onclick="Europa.Controllers.Simulador.AbrirSimulador()">
                                <i class="fas fa-archive"></i> Simulador
                            </button>
                        }
                    </div>
                </div>

                <div class="d-flex">
                    <div class="flex-grow-1">
                        <form id="form-simulador">
                            <div ng-controller="ResultadoSimulacaoModalTable as simulacao">
                                <div id="resultado_simulacao_datatable_modal_header">
                                    <h5>@GlobalMessages.Resultado da Simulação</h5>
                                </div>
                                <table datatable="" dt-options="simulacao.dtOptions" dt-columns="simulacao.dtColumns"
                                       dt-instance="simulacao.dtInstance" class="table table-striped table-bordered"
                                       dt-column-defs="simulacao.dtColumnDefs"></table>
                            </div>
                        </form>
                    </div>
                    @*Detalahmento financeiro*@
                    <div class="flex-grow-1" style="margin-top: -8px">
                        <div ng-controller="DetalhamentoFinanceiroModalSimulador as table" class="p-2">
                            <div id="detalhamento_financeiro_datatable_modal_header">
                                <div class="flex-row">
                                    <h5>@GlobalMessages.DetalhamentoFinanceiro</h5>
                                    @if (Model.PodeManterAssociacoes && SessionAttributes.Current().HasPermission(ViewBag.Codigo, "AplicarSimulacao"))
                                    {
                                        <button id="btn-aplicar-simulacao" class="btn button__red__outline" type="button" onclick="Europa.Controllers.Simulador.AplicarDetalhamentoFinanceiro()">Aplicar Simulação</button>
                                    }
                                    @if (Model.PodeManterAssociacoes && SessionAttributes.Current().HasPermission(ViewBag.Codigo, "DetalhamentoFinanceiroManual"))
                                    {
                                        <button id="btn-novo-detalhamento-simulacao" class="btn button__red__outline" type="button" title="@GlobalMessages.Novo" onClick="Europa.Controllers.Simulador.NovoDetalhamentoFinanceiro()"><i class="fa fa-plus" aria-hidden="true"></i> @GlobalMessages.Novo</button>
                                    }
                                </div>
                            </div>
                            <table datatable="" dt-options="table.dtOptions" dt-columns="table.dtColumns"
                                   dt-instance="table.dtInstance" class="table table-striped table-bordered"
                                   dt-column-defs="table.dtColumnDefs"></table>
                        </div>

                        @*Itbl e emolumentos*@
                        <div ng-controller="ItbiEmolumentoModalSimulador as itbi" class="p-2">
                            <div id="itbi_emolumento_datatable_modal_header">
                                <div class="col-md-24">
                                    <div class="col-md-8 ">
                                        <h5>@GlobalMessages.ItbiEmolumentos</h5>
                                    </div>
                                    <div class="pull-right">
                                        @if (Model.PodeManterAssociacoes && SessionAttributes.Current().HasPermission(ViewBag.Codigo, "DetalhamentoFinanceiroManual"))
                                        {
                                            <button id="btn-novo-itbi-simulacao"  class="btn button__red__outline" type="button" title="@GlobalMessages.Novo" onClick="Europa.Controllers.Simulador.NovoItbiEmolumento()"><i class="fa fa-plus" aria-hidden="true"></i> @GlobalMessages.Novo</button>
                                        }
                                    </div>
                                </div>
                            </div>
                            <table datatable="" dt-options="itbi.dtOptions" dt-columns="itbi.dtColumns"
                                   dt-instance="itbi.dtInstance" class="table table-striped table-bordered"
                                   dt-column-defs="itbi.dtColumnDefs"></table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn button__red__outline" onclick="Europa.Controllers.Simulador.FecharModalSimulador()"><i class="fa fa-close"></i> @GlobalMessages.Fechar</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
